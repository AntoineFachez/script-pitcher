rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // (KEEP AS-IS) This is correct for self-read/write.
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // (KEEP AS-IS) This is correct.
    match /fileId_to_projectId_lookup/{fileId} {
      allow read: if request.auth != null;
    }

   match /projects/{projectId} {
      // TODO: adjust rules for viewers to not see other members
      
      // Allow GET (reading one doc) if the user is a member
      allow get: if request.auth != null && 
                   request.auth.uid in resource.data.members;
      
      // Allow LIST (running a query) if the user is authenticated.
      // This is safe ONLY because your 'getProjectsAndMembers' function
      // already scopes the query to trusted project IDs from the user's
      // private summary document.
      allow list: if request.auth != null;

      
      // Sub-collections must now also use 'resource.data' from the parent context,
      // or re-fetch the project data via 'get()' if security is layered.
      // Since 'files', 'characters', and 'episodes' rules reference the parent project, 
      // the existing 'get(...)' is correct for those nested rules.

      match /files/{fileId} {
        allow get, list, read: if request.auth != null && 
                                  request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.members;
      }

      match /characters/{characterId} {
        allow read: if request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.members;
        allow write: if false; 
      }
      
      match /episodes/{episodeId} {
        allow read: if request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.members;
        allow write: if false; 
      }
    
      // TODO: adjust rules for non owner to not see invitations
      match /invitations/{invitationId} {
        allow read: if request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.members;
        allow write: if false; 
      }
    }
  }
}